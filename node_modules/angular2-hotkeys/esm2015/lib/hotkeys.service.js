import { __decorate, __param } from "tslib";
import { Inject, Injectable } from '@angular/core';
import { Hotkey } from './hotkey.model';
import { Subject } from 'rxjs';
import { HotkeyOptions } from './hotkey.options';
import 'mousetrap';
import * as i0 from "@angular/core";
import * as i1 from "./hotkey.options";
let HotkeysService = class HotkeysService {
    constructor(options) {
        this.options = options;
        this.hotkeys = [];
        this.pausedHotkeys = [];
        this.cheatSheetToggle = new Subject();
        this.preventIn = ['INPUT', 'SELECT', 'TEXTAREA'];
        // noinspection JSUnusedGlobalSymbols,JSUnusedLocalSymbols
        Mousetrap.prototype.stopCallback = (event, element, combo, callback) => {
            // if the element has the class "mousetrap" then no need to stop
            if ((' ' + element.className + ' ').indexOf(' mousetrap ') > -1) {
                return false;
            }
            return (element.contentEditable && element.contentEditable === 'true');
        };
        this.mousetrap = new Mousetrap();
        if (!this.options.disableCheatSheet) {
            this.add(new Hotkey(this.options.cheatSheetHotkey || '?', function (_) {
                this.cheatSheetToggle.next();
            }.bind(this), [], this.options.cheatSheetDescription || 'Show / hide this help menu'));
        }
        if (this.options.cheatSheetCloseEsc) {
            this.add(new Hotkey('esc', function (_) {
                this.cheatSheetToggle.next(false);
            }.bind(this), ['HOTKEYS-CHEATSHEET'], this.options.cheatSheetCloseEscDescription || 'Hide this help menu'));
        }
    }
    add(hotkey, specificEvent) {
        if (Array.isArray(hotkey)) {
            const temp = [];
            for (const key of hotkey) {
                temp.push(this.add(key, specificEvent));
            }
            return temp;
        }
        this.remove(hotkey);
        this.hotkeys.push(hotkey);
        this.mousetrap.bind(hotkey.combo, (event, combo) => {
            let shouldExecute = true;
            // if the callback is executed directly `hotkey.get('w').callback()`
            // there will be no event, so just execute the callback.
            if (event) {
                const target = (event.target || event.srcElement); // srcElement is IE only
                const nodeName = target.nodeName.toUpperCase();
                // check if the input has a mousetrap class, and skip checking preventIn if so
                if ((' ' + target.className + ' ').indexOf(' mousetrap ') > -1) {
                    shouldExecute = true;
                }
                else if (this.preventIn.indexOf(nodeName) > -1 &&
                    hotkey.allowIn.map(allow => allow.toUpperCase()).indexOf(nodeName) === -1) {
                    // don't execute callback if the event was fired from inside an element listed in preventIn but not in allowIn
                    shouldExecute = false;
                }
            }
            if (shouldExecute) {
                return hotkey.callback.apply(this, [event, combo]);
            }
        }, specificEvent);
        return hotkey;
    }
    remove(hotkey) {
        const temp = [];
        if (!hotkey) {
            for (const key of this.hotkeys) {
                temp.push(this.remove(key));
            }
            return temp;
        }
        if (Array.isArray(hotkey)) {
            for (const key of hotkey) {
                temp.push(this.remove(key));
            }
            return temp;
        }
        const index = this.findHotkey(hotkey);
        if (index > -1) {
            this.hotkeys.splice(index, 1);
            this.mousetrap.unbind(hotkey.combo);
            return hotkey;
        }
        return null;
    }
    get(combo) {
        if (!combo) {
            return this.hotkeys;
        }
        if (Array.isArray(combo)) {
            const temp = [];
            for (const key of combo) {
                temp.push(this.get(key));
            }
            return temp;
        }
        for (const hotkey of this.hotkeys) {
            if (hotkey.combo.indexOf(combo) > -1) {
                return hotkey;
            }
        }
        return null;
    }
    // noinspection JSUnusedGlobalSymbols
    pause(hotkey) {
        if (!hotkey) {
            return this.pause(this.hotkeys);
        }
        if (Array.isArray(hotkey)) {
            const temp = [];
            for (const key of hotkey) {
                temp.push(this.pause(key));
            }
            return temp;
        }
        this.remove(hotkey);
        this.pausedHotkeys.push(hotkey);
        return hotkey;
    }
    // noinspection JSUnusedGlobalSymbols
    unpause(hotkey) {
        if (!hotkey) {
            return this.unpause(this.pausedHotkeys);
        }
        if (Array.isArray(hotkey)) {
            const temp = [];
            for (const key of hotkey) {
                temp.push(this.unpause(key));
            }
            return temp;
        }
        const index = this.pausedHotkeys.indexOf(hotkey);
        if (index > -1) {
            this.add(hotkey);
            return this.pausedHotkeys.splice(index, 1);
        }
        return null;
    }
    // noinspection JSUnusedGlobalSymbols
    reset() {
        this.mousetrap.reset();
    }
    findHotkey(hotkey) {
        return this.hotkeys.indexOf(hotkey);
    }
};
HotkeysService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [HotkeyOptions,] }] }
];
HotkeysService.ɵprov = i0.ɵɵdefineInjectable({ factory: function HotkeysService_Factory() { return new HotkeysService(i0.ɵɵinject(i1.HotkeyOptions)); }, token: HotkeysService, providedIn: "root" });
HotkeysService = __decorate([
    Injectable({
        providedIn: 'root'
    }),
    __param(0, Inject(HotkeyOptions))
], HotkeysService);
export { HotkeysService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90a2V5cy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhcjItaG90a2V5cy8iLCJzb3VyY2VzIjpbImxpYi9ob3RrZXlzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxhQUFhLEVBQWtCLE1BQU0sa0JBQWtCLENBQUM7QUFDakUsT0FBTyxXQUFXLENBQUM7OztBQUtuQixJQUFhLGNBQWMsR0FBM0IsTUFBYSxjQUFjO0lBUXZCLFlBQTJDLE9BQXVCO1FBQXZCLFlBQU8sR0FBUCxPQUFPLENBQWdCO1FBUGxFLFlBQU8sR0FBYSxFQUFFLENBQUM7UUFDdkIsa0JBQWEsR0FBYSxFQUFFLENBQUM7UUFFN0IscUJBQWdCLEdBQWlCLElBQUksT0FBTyxFQUFFLENBQUM7UUFFdkMsY0FBUyxHQUFHLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUdoRCwwREFBMEQ7UUFDMUQsU0FBUyxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxLQUFvQixFQUFFLE9BQW9CLEVBQUUsS0FBYSxFQUFFLFFBQWtCLEVBQUUsRUFBRTtZQUNqSCxnRUFBZ0U7WUFDaEUsSUFBSSxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtnQkFDN0QsT0FBTyxLQUFLLENBQUM7YUFDaEI7WUFDRCxPQUFPLENBQUMsT0FBTyxDQUFDLGVBQWUsSUFBSSxPQUFPLENBQUMsZUFBZSxLQUFLLE1BQU0sQ0FBQyxDQUFDO1FBQzNFLENBQUMsQ0FBQztRQUNG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QU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN2QixNQUFNLElBQUksR0FBYSxFQUFFLENBQUM7WUFDMUIsS0FBSyxNQUFNLEdBQUcsSUFBSSxNQUFNLEVBQUU7Z0JBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQVcsQ0FBQyxDQUFDO2FBQzFDO1lBQ0QsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELE1BQU0sS0FBSyxHQUFXLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLE1BQWdCLENBQUMsQ0FBQztRQUNuRSxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsRUFBRTtZQUNaLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDakIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDOUM7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQscUNBQXFDO0lBQ3JDLEtBQUs7UUFDRCxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFTyxVQUFVLENBQUMsTUFBYztRQUM3QixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3hDLENBQUM7Q0FDSixDQUFBOzs0Q0E3SmdCLE1BQU0sU0FBQyxhQUFhOzs7QUFSeEIsY0FBYztJQUgxQixVQUFVLENBQUM7UUFDUixVQUFVLEVBQUUsTUFBTTtLQUNyQixDQUFDO0lBU2UsV0FBQSxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUE7R0FSekIsY0FBYyxDQXFLMUI7U0FyS1ksY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSG90a2V5IH0gZnJvbSAnLi9ob3RrZXkubW9kZWwnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSG90a2V5T3B0aW9ucywgSUhvdGtleU9wdGlvbnMgfSBmcm9tICcuL2hvdGtleS5vcHRpb25zJztcbmltcG9ydCAnbW91c2V0cmFwJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBIb3RrZXlzU2VydmljZSB7XG4gICAgaG90a2V5czogSG90a2V5W10gPSBbXTtcbiAgICBwYXVzZWRIb3RrZXlzOiBIb3RrZXlbXSA9IFtdO1xuICAgIG1vdXNldHJhcDogTW91c2V0cmFwSW5zdGFuY2U7XG4gICAgY2hlYXRTaGVldFRvZ2dsZTogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3QoKTtcblxuICAgIHByaXZhdGUgcHJldmVudEluID0gWydJTlBVVCcsICdTRUxFQ1QnLCAnVEVYVEFSRUEnXTtcblxuICAgIGNvbnN0cnVjdG9yKEBJbmplY3QoSG90a2V5T3B0aW9ucykgcHJpdmF0ZSBvcHRpb25zOiBJSG90a2V5T3B0aW9ucykge1xuICAgICAgICAvLyBub2luc3BlY3Rpb24gSlNVbnVzZWRHbG9iYWxTeW1ib2xzLEpTVW51c2VkTG9jYWxTeW1ib2xzXG4gICAgICAgIE1vdXNldHJhcC5wcm90b3R5cGUuc3RvcENhbGxiYWNrID0gKGV2ZW50OiBLZXlib2FyZEV2ZW50LCBlbGVtZW50OiBIVE1MRWxlbWVudCwgY29tYm86IHN0cmluZywgY2FsbGJhY2s6IEZ1bmN0aW9uKSA9PiB7XG4gICAgICAgICAgICAvLyBpZiB0aGUgZWxlbWVudCBoYXMgdGhlIGNsYXNzIFwibW91c2V0cmFwXCIgdGhlbiBubyBuZWVkIHRvIHN0b3BcbiAgICAgICAgICAgIGlmICgoJyAnICsgZWxlbWVudC5jbGFzc05hbWUgKyAnICcpLmluZGV4T2YoJyBtb3VzZXRyYXAgJykgPiAtMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAoZWxlbWVudC5jb250ZW50RWRpdGFibGUgJiYgZWxlbWVudC5jb250ZW50RWRpdGFibGUgPT09ICd0cnVlJyk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMubW91c2V0cmFwID0gbmV3IChNb3VzZXRyYXAgYXMgYW55KSgpO1xuICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5kaXNhYmxlQ2hlYXRTaGVldCkge1xuICAgICAgICAgICAgdGhpcy5hZGQobmV3IEhvdGtleShcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuY2hlYXRTaGVldEhvdGtleSB8fCAnPycsXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24oXzogS2V5Ym9hcmRFdmVudCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWF0U2hlZXRUb2dnbGUubmV4dCgpO1xuICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKSxcbiAgICAgICAgICAgICAgICBbXSxcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuY2hlYXRTaGVldERlc2NyaXB0aW9uIHx8ICdTaG93IC8gaGlkZSB0aGlzIGhlbHAgbWVudScsXG4gICAgICAgICAgICApKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuY2hlYXRTaGVldENsb3NlRXNjKSB7XG4gICAgICAgICAgICB0aGlzLmFkZChuZXcgSG90a2V5KFxuICAgICAgICAgICAgICAgICdlc2MnLFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uKF86IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGVhdFNoZWV0VG9nZ2xlLm5leHQoZmFsc2UpO1xuICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKSxcbiAgICAgICAgICAgICAgICBbJ0hPVEtFWVMtQ0hFQVRTSEVFVCddLFxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5jaGVhdFNoZWV0Q2xvc2VFc2NEZXNjcmlwdGlvbiB8fCAnSGlkZSB0aGlzIGhlbHAgbWVudScsXG4gICAgICAgICAgICApKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgYWRkKGhvdGtleTogSG90a2V5IHwgSG90a2V5W10sIHNwZWNpZmljRXZlbnQ/OiBzdHJpbmcpOiBIb3RrZXkgfCBIb3RrZXlbXSB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhvdGtleSkpIHtcbiAgICAgICAgICAgIGNvbnN0IHRlbXA6IEhvdGtleVtdID0gW107XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBob3RrZXkpIHtcbiAgICAgICAgICAgICAgICB0ZW1wLnB1c2godGhpcy5hZGQoa2V5LCBzcGVjaWZpY0V2ZW50KSBhcyBIb3RrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRlbXA7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZW1vdmUoaG90a2V5KTtcbiAgICAgICAgdGhpcy5ob3RrZXlzLnB1c2goaG90a2V5IGFzIEhvdGtleSk7XG4gICAgICAgIHRoaXMubW91c2V0cmFwLmJpbmQoKGhvdGtleSBhcyBIb3RrZXkpLmNvbWJvLCAoZXZlbnQ6IEtleWJvYXJkRXZlbnQsIGNvbWJvOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIGxldCBzaG91bGRFeGVjdXRlID0gdHJ1ZTtcblxuICAgICAgICAgICAgLy8gaWYgdGhlIGNhbGxiYWNrIGlzIGV4ZWN1dGVkIGRpcmVjdGx5IGBob3RrZXkuZ2V0KCd3JykuY2FsbGJhY2soKWBcbiAgICAgICAgICAgIC8vIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQsIHNvIGp1c3QgZXhlY3V0ZSB0aGUgY2FsbGJhY2suXG4gICAgICAgICAgICBpZiAoZXZlbnQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQ6IEhUTUxFbGVtZW50ID0gKGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50KSBhcyBIVE1MRWxlbWVudDsgLy8gc3JjRWxlbWVudCBpcyBJRSBvbmx5XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZU5hbWU6IHN0cmluZyA9IHRhcmdldC5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpO1xuXG4gICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgdGhlIGlucHV0IGhhcyBhIG1vdXNldHJhcCBjbGFzcywgYW5kIHNraXAgY2hlY2tpbmcgcHJldmVudEluIGlmIHNvXG4gICAgICAgICAgICAgICAgaWYgKCgnICcgKyB0YXJnZXQuY2xhc3NOYW1lICsgJyAnKS5pbmRleE9mKCcgbW91c2V0cmFwICcpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgc2hvdWxkRXhlY3V0ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnByZXZlbnRJbi5pbmRleE9mKG5vZGVOYW1lKSA+IC0xICYmXG4gICAgICAgICAgICAgICAgICAgIChob3RrZXkgYXMgSG90a2V5KS5hbGxvd0luLm1hcChhbGxvdyA9PiBhbGxvdy50b1VwcGVyQ2FzZSgpKS5pbmRleE9mKG5vZGVOYW1lKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gZG9uJ3QgZXhlY3V0ZSBjYWxsYmFjayBpZiB0aGUgZXZlbnQgd2FzIGZpcmVkIGZyb20gaW5zaWRlIGFuIGVsZW1lbnQgbGlzdGVkIGluIHByZXZlbnRJbiBidXQgbm90IGluIGFsbG93SW5cbiAgICAgICAgICAgICAgICAgICAgc2hvdWxkRXhlY3V0ZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHNob3VsZEV4ZWN1dGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKGhvdGtleSBhcyBIb3RrZXkpLmNhbGxiYWNrLmFwcGx5KHRoaXMsIFtldmVudCwgY29tYm9dKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgc3BlY2lmaWNFdmVudCk7XG4gICAgICAgIHJldHVybiBob3RrZXk7XG4gICAgfVxuXG4gICAgcmVtb3ZlKGhvdGtleT86IEhvdGtleSB8IEhvdGtleVtdKTogSG90a2V5IHwgSG90a2V5W10ge1xuICAgICAgICBjb25zdCB0ZW1wOiBIb3RrZXlbXSA9IFtdO1xuICAgICAgICBpZiAoIWhvdGtleSkge1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgdGhpcy5ob3RrZXlzKSB7XG4gICAgICAgICAgICAgICAgdGVtcC5wdXNoKHRoaXMucmVtb3ZlKGtleSkgYXMgSG90a2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0ZW1wO1xuICAgICAgICB9XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhvdGtleSkpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIGhvdGtleSkge1xuICAgICAgICAgICAgICAgIHRlbXAucHVzaCh0aGlzLnJlbW92ZShrZXkpIGFzIEhvdGtleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGVtcDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuZmluZEhvdGtleShob3RrZXkgYXMgSG90a2V5KTtcbiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgIHRoaXMuaG90a2V5cy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgdGhpcy5tb3VzZXRyYXAudW5iaW5kKChob3RrZXkgYXMgSG90a2V5KS5jb21ibyk7XG4gICAgICAgICAgICByZXR1cm4gaG90a2V5O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGdldChjb21ibz86IHN0cmluZyB8IHN0cmluZ1tdKTogSG90a2V5IHwgSG90a2V5W10ge1xuICAgICAgICBpZiAoIWNvbWJvKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ob3RrZXlzO1xuICAgICAgICB9XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbWJvKSkge1xuICAgICAgICAgICAgY29uc3QgdGVtcDogSG90a2V5W10gPSBbXTtcbiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIGNvbWJvKSB7XG4gICAgICAgICAgICAgICAgdGVtcC5wdXNoKHRoaXMuZ2V0KGtleSkgYXMgSG90a2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0ZW1wO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3QgaG90a2V5IG9mIHRoaXMuaG90a2V5cykge1xuICAgICAgICAgICAgaWYgKGhvdGtleS5jb21iby5pbmRleE9mKGNvbWJvIGFzIHN0cmluZykgPiAtMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBob3RrZXk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gbm9pbnNwZWN0aW9uIEpTVW51c2VkR2xvYmFsU3ltYm9sc1xuICAgIHBhdXNlKGhvdGtleT86IEhvdGtleSB8IEhvdGtleVtdKTogSG90a2V5IHwgSG90a2V5W10ge1xuICAgICAgICBpZiAoIWhvdGtleSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucGF1c2UodGhpcy5ob3RrZXlzKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShob3RrZXkpKSB7XG4gICAgICAgICAgICBjb25zdCB0ZW1wOiBIb3RrZXlbXSA9IFtdO1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgaG90a2V5KSB7XG4gICAgICAgICAgICAgICAgdGVtcC5wdXNoKHRoaXMucGF1c2Uoa2V5KSBhcyBIb3RrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRlbXA7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZW1vdmUoaG90a2V5KTtcbiAgICAgICAgdGhpcy5wYXVzZWRIb3RrZXlzLnB1c2goaG90a2V5IGFzIEhvdGtleSk7XG4gICAgICAgIHJldHVybiBob3RrZXk7XG4gICAgfVxuXG4gICAgLy8gbm9pbnNwZWN0aW9uIEpTVW51c2VkR2xvYmFsU3ltYm9sc1xuICAgIHVucGF1c2UoaG90a2V5PzogSG90a2V5IHwgSG90a2V5W10pOiBIb3RrZXkgfCBIb3RrZXlbXSB7XG4gICAgICAgIGlmICghaG90a2V5KSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy51bnBhdXNlKHRoaXMucGF1c2VkSG90a2V5cyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaG90a2V5KSkge1xuICAgICAgICAgICAgY29uc3QgdGVtcDogSG90a2V5W10gPSBbXTtcbiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIGhvdGtleSkge1xuICAgICAgICAgICAgICAgIHRlbXAucHVzaCh0aGlzLnVucGF1c2Uoa2V5KSBhcyBIb3RrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRlbXA7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaW5kZXg6IG51bWJlciA9IHRoaXMucGF1c2VkSG90a2V5cy5pbmRleE9mKGhvdGtleSBhcyBIb3RrZXkpO1xuICAgICAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgICAgICAgdGhpcy5hZGQoaG90a2V5KTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhdXNlZEhvdGtleXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBub2luc3BlY3Rpb24gSlNVbnVzZWRHbG9iYWxTeW1ib2xzXG4gICAgcmVzZXQoKSB7XG4gICAgICAgIHRoaXMubW91c2V0cmFwLnJlc2V0KCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmaW5kSG90a2V5KGhvdGtleTogSG90a2V5KTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaG90a2V5cy5pbmRleE9mKGhvdGtleSk7XG4gICAgfVxufVxuXG4iXX0=